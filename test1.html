<!DOCTYPE html>
<html>

<head>
  <script data-require="d3@3.5.3" data-semver="3.5.3" src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.js"></script>
  <style>

  body {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    width: 960px;
    height: 500px;
    position: relative;
  }
    body {
      font: 10px sans-serif;
    }

    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .x.axis path {
      display: none;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 1.5px;
    }
  </style>
</head>

<body>
  <script>
    var myData = "Year	White_Percent White_not_Hispanic_Percent Black_Percent Asian_Percent Hispanic_Percent\n\
2015	66.2	41.2	25	5.2	28.1\n\
2014	66.6	42.1	24.8	4.9	28.1\n\
2013	66.8	41.9	25.2	4.8	28.5\n\
2012	66.3	40.7	25.4	4.5	29.3\n\
2011	66.7	41.5	25.4	4.7	28.6\n\
2010	67.1	41.5	25	4.5	29.2\n\
2009	68.5	42.5	24.3	4.4	28.3\n\
2008	67.8	42.7	24.8	4.2	27.6\n\
2007	67.4	43	25.9	3.9	26.5\n\
2006	67	43.9	25.9	4	25.4\n\
2005	67.3	43.9	25.8	4.1	25.4\n\
2004	68.4	45.6	25.4	3.5	24.6\n\
2003	67.7	44.3	25.4	4.3	25.2\n\
2002	67.9	45	25.7	3.6	24.7\n\
2001	69.1	46.4	24.7	3.9	24.3\n\
2000	68.5	45.5	25.3	4	24.5\n\
1999	67.6	44.9	25.7	3.9	24\n\
1998	68	45.8	26.4	3.9	23.4\n\
1997	68.6	46.4	25.6	4.1	23.4\n\
1996	67.5	45.1	26.5	4	23.8\n\
1995	67.1	44.7	27.1	3.9	23.5\n\
1994	66.7	47.6	26.8	2.6	22.1\n\
1993	66.8	48.1	27.7	2.9	20.7\n\
1992	66.4	47.9	28.5	2.6	20\n\
1991	66.5	49.7	28.7	2.8	17.8\n\
1990	66.5	49.5	29.3	2.6	17.9\n";

    var margin = {
        top: 20,
        right: 80,
        bottom: 30,
        left: 50
      },
      width = 900 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

    var parseDate = d3.time.format("%Y").parse;

    var x = d3.time.scale()
      .range([0, width]);

    var y = d3.scale.linear()
      .range([height, 0]);

    var color = d3.scale.category10();

    var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");

    var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");

    var line = d3.svg.line()
      .interpolate("basis")
      .x(function(d) {
        return x(d.Year);
      })
      .y(function(d) {
        return y(d.Percentage);
      });

    var svg = d3.select("body").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var data = d3.tsv.parse(myData);

    color.domain(d3.keys(data[0]).filter(function(key) {
      return key !== "Year";
    }));

    data.forEach(function(d) {
      d.Year = parseDate(d.Year);
    });

    var races = color.domain().map(function(name) {
      return {
        name: name,
        values: data.map(function(d) {
          return {
            Year: d.Year,
            Percentage: +d[name]
          };
        })
      };
    });

    x.domain(d3.extent(data, function(d) {
      return d.Year;
    }));

    y.domain([
      d3.min(races, function(c) {
        return d3.min(c.values, function(v) {
          return v.Percentage;
        });
      }),
      d3.max(races, function(c) {
        return d3.max(c.values, function(v) {
          return v.Percentage;
        });
      })
    ]);

    var legend = svg.selectAll('g')
      .data(races)
      .enter()
      .append('g')
      .attr('class', 'legend');

    legend.append('rect')
      .attr('x', width - 20)
      .attr('y', function(d, i) {
        return i * 20;
      })
      .attr('width', 10)
      .attr('height', 10)
      .style('fill', function(d) {
        return color(d.name);
      });

    legend.append('text')
      .attr('x', width - 8)
      .attr('y', function(d, i) {
        return (i * 20) + 9;
      })
      .text(function(d) {
        return d.name;
      });

    svg.append("g")
      .attr("class", "x axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

    svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 6)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Percentage (%)");

    var race = svg.selectAll(".race")
      .data(races)
      .enter().append("g")
      .attr("class", "race");

    race.append("path")
      .attr("class", "line")
      .attr("d", function(d) {
        return line(d.values);
      })
      .style("stroke", function(d) {
        return color(d.name);
      });

    race.append("text")
      .datum(function(d) {
        return {
          name: d.name,
          value: d.values[d.values.length - 1]
        };
      })
      .attr("transform", function(d) {
        return "translate(" + x(d.value.Year) + "," + y(d.value.Percentage) + ")";
      })
      .attr("x", 3)
      .attr("dy", ".35em")
      .text(function(d) {
        return d.name;
      });

    var mouseG = svg.append("g")
      .attr("class", "mouse-over-effects");

    mouseG.append("path") // this is the black vertical line to follow mouse
      .attr("class", "mouse-line")
      .style("stroke", "black")
      .style("stroke-width", "1px")
      .style("race", "0");

    var lines = document.getElementsByClassName('line');

    var mousePerLine = mouseG.selectAll('.mouse-per-line')
      .data(races)
      .enter()
      .append("g")
      .attr("class", "mouse-per-line");

    mousePerLine.append("circle")
      .attr("r", 7)
      .style("stroke", function(d) {
        return color(d.name);
      })
      .style("fill", "none")
      .style("stroke-width", "1px")
      .style("race", "0");

    mousePerLine.append("text")
      .attr("transform", "translate(10,3)");

    mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
      .attr('width', width) // can't catch mouse events on a g element
      .attr('height', height)
      .attr('fill', 'none')
      .attr('pointer-events', 'all')
      .on('mouseout', function() { // on mouse out hide line, circles and text
        d3.select(".mouse-line")
          .style("race", "0");
        d3.selectAll(".mouse-per-line circle")
          .style("race", "0");
        d3.selectAll(".mouse-per-line text")
          .style("race", "0");
      })
      .on('mouseover', function() { // on mouse in show line, circles and text
        d3.select(".mouse-line")
          .style("race", "1");
        d3.selectAll(".mouse-per-line circle")
          .style("race", "1");
        d3.selectAll(".mouse-per-line text")
          .style("race", "1");
      })
      .on('mousemove', function() { // mouse moving over canvas
        var mouse = d3.mouse(this);
        d3.select(".mouse-line")
          .attr("d", function() {
            var d = "M" + mouse[0] + "," + height;
            d += " " + mouse[0] + "," + 0;
            return d;
          });

        d3.selectAll(".mouse-per-line")
          .attr("transform", function(d, i) {
            console.log(width/mouse[0])
            var xDate = x.invert(mouse[0]),
                bisect = d3.bisector(function(d) { return d.Year; }).right;
                idx = bisect(d.values, xDate);

            var beginning = 0,
                end = lines[i].getTotalLength(),
                target = null;

            while (true){
              target = Math.floor((beginning + end) / 2);
              pos = lines[i].getPointAtLength(target);
              if ((target === end || target === beginning) && pos.x !== mouse[0]) {
                  break;
              }
              if (pos.x > mouse[0])      end = target;
              else if (pos.x < mouse[0]) beginning = target;
              else break; //position found
            }

            d3.select(this).select('text')
              .text(y.invert(pos.y).toFixed(2));

            return "translate(" + mouse[0] + "," + pos.y +")";
          });
      });

  </script>
</body>

</html>
